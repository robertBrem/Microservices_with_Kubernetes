<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Setup Cassandra - Microservices with Kubernetes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Setup Cassandra";
    var mkdocs_page_input_path = "17_Event_Sourcing_with_Cassandra/01_Setup_Cassandra.md";
    var mkdocs_page_url = "/17_Event_Sourcing_with_Cassandra/01_Setup_Cassandra/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Microservices with Kubernetes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Microservices with Kubernetes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../README/">Microservices with Kubernetes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">01 Setup</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../01_Setup/01_Host_setup/">Setup your local host machine</a>
                </li>
                <li class="">
                    
    <a class="" href="../../01_Setup/02_Kubernetes_setup/">Setup a Kubernetes cluster</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">02 First rest service</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../02_First_rest_service/01_JavaEE_service/">Creating our first JavaEE microservice</a>
                </li>
                <li class="">
                    
    <a class="" href="../../02_First_rest_service/02_Dockerization/">Dockerization of the service</a>
                </li>
                <li class="">
                    
    <a class="" href="../../02_First_rest_service/03_Deploy_in_Kubernetes/">Deploy the Docker image of the service in Kubernetes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">03 Docker registry</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../03_Docker_registry/01_Setup_a_docker_registry/">Setup a docker registry</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">04 Jenkins</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../04_Jenkins/01_Setup_Jenkins_in_Kubernetes/">Setup Jenkins in Kubernetes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">05 Build and push ci step</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../05_Build_and_push_ci_step/01_Build_and_push_CI_step/">Build and push CI step</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">06 Systemtest ci step</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../06_Systemtest_ci_step/01_Setup_test_env/">Setup the test environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../../06_Systemtest_ci_step/02_Systemtest/">Add a system test</a>
                </li>
                <li class="">
                    
    <a class="" href="../../06_Systemtest_ci_step/03_Start_pipeline_on_every_push/">Start the Jenkins pipeline on every push</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">07 UI test</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../07_UI_test/01_UI_Test/">UI Test</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">08 Lasttest</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../08_Lasttest/01_Last_test/">Last test</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">09 Manual test</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../09_Manual_test/01_Create_manual_test/">Create manual test</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">10 Canary release</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../10_Canary_release/01_Create_a_canary_release/">Create a canary release</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">11 Full production release</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../11_Full_production_release/01_Go_full_production/">Go full production with the new version</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">12 Own Gogs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../12_Own_Gogs/01_Use_your_own_Git_repository/">Use your own Git repository</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">13 Monitoring</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../13_Monitoring/01_Dashboard/">Kubernetes dashboard</a>
                </li>
                <li class="">
                    
    <a class="" href="../../13_Monitoring/02_Prometheus/">Monitoring with Prometheus</a>
                </li>
                <li class="">
                    
    <a class="" href="../../13_Monitoring/03_Weave_scope/">Weave Scope</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">14 Documentation of rest service</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../14_Documentation_of_rest_service/01_Documentation/">Documentation of the `jax-rs` service</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">15 Angular2 frontend</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../15_Angular2_frontend/01_Initial_setup/">Create an Angular 2 frontend</a>
                </li>
                <li class="">
                    
    <a class="" href="../../15_Angular2_frontend/02_Test_and_prod_stage/">Create a test and production stage</a>
                </li>
                <li class="">
                    
    <a class="" href="../../15_Angular2_frontend/03_First_view/">Creation of the first view</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">16 SSO with Keycloak</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../16_SSO_with_Keycloak/01_Setup_Keycloak/">Setup Keycloak</a>
                </li>
                <li class="">
                    
    <a class="" href="../../16_SSO_with_Keycloak/02_Initial_setup_of_Keycloak/">Initial setup of Keycloak</a>
                </li>
                <li class="">
                    
    <a class="" href="../../16_SSO_with_Keycloak/03_Secure_REST_service/">Secure the `jax-rs` service</a>
                </li>
                <li class="">
                    
    <a class="" href="../../16_SSO_with_Keycloak/04_Secure_frontend_service/">Secure the Angular2 frontend service</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">17 Event Sourcing with Cassandra</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Setup Cassandra</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#setup-cassandra">Setup Cassandra</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#setup-cassandra-on-the-local-machine">Setup Cassandra on the local machine</a></li>
        
            <li><a class="toctree-l4" href="#setup-cassandra-in-the-cluster">Setup Cassandra in the cluster</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../02_REST_service_with_event_sourcing/">02 REST service with event sourcing</a>
                </li>
                <li class="">
                    
    <a class="" href="../03_Changes_to_the_frontend/">03 Changes to the frontend</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">18 Connect keycloak user with application user</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../18_Connect_keycloak_user_with_application_user/01_Setup_keycloak_with_a_provider/">01 Setup keycloak with a provider</a>
                </li>
                <li class="">
                    
    <a class="" href="../../18_Connect_keycloak_user_with_application_user/02_Changes_to_the_REST_service/">02 Changes to the REST service</a>
                </li>
                <li class="">
                    
    <a class="" href="../../18_Connect_keycloak_user_with_application_user/03_Changes_in_the_environment/">03 Changes in the environment</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">19 CQRS with Kafka</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../19_CQRS_with_Kafka/01_Setup_Kafka/">01 Setup Kafka</a>
                </li>
                <li class="">
                    
    <a class="" href="../../19_CQRS_with_Kafka/02_Command_service/">02 Command service</a>
                </li>
                <li class="">
                    
    <a class="" href="../../19_CQRS_with_Kafka/03_Query_service/">03 Query service</a>
                </li>
                <li class="">
                    
    <a class="" href="../../19_CQRS_with_Kafka/04_Frontend_service/">04 Frontend service</a>
                </li>
                <li class="">
                    
    <a class="" href="../../19_CQRS_with_Kafka/05_Other_updates/">05 Other updates</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">20 Fileuploader</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../20_Fileuploader/01_Create_fileuploader_service/">01 Create fileuploader service</a>
                </li>
                <li class="">
                    
    <a class="" href="../../20_Fileuploader/02_REST_service_adaptions/">02 REST service adaptions</a>
                </li>
                <li class="">
                    
    <a class="" href="../../20_Fileuploader/03_Query_service_adaptions/">03 Query service adaptions</a>
                </li>
                <li class="">
                    
    <a class="" href="../../20_Fileuploader/04_Frontend_adaptions/">04 Frontend adaptions</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Microservices with Kubernetes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>17 Event Sourcing with Cassandra &raquo;</li>
        
      
    
    <li>Setup Cassandra</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/robertBrem/Microservices_with_Kubernetes/edit/master/docs/17_Event_Sourcing_with_Cassandra/01_Setup_Cassandra.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="setup-cassandra">Setup Cassandra</h1>
<h2 id="setup-cassandra-on-the-local-machine">Setup Cassandra on the local machine</h2>
<p>To start Cassandra on our local machine we've to execute the following
script:</p>
<pre><code>#!/usr/bin/env bash

docker stop cassandra
docker rm cassandra
docker run --name cassandra -d -e CASSANDRA_START_RPC=true -p 9160:9160 -p 9042:9042 -p 7199:7199 -p 7001:7001 -p 7000:7000 cassandra
echo &quot;wait for cassandra to start&quot;
while ! docker logs cassandra | grep &quot;Listening for thrift clients...&quot;
do
 echo &quot;$(date) - still trying&quot;
 sleep 1
done
echo &quot;$(date) - connected successfully&quot;

echo &quot;copy init script in container&quot;
docker cp initial_db.sql cassandra:/

echo &quot;create database&quot;
docker exec -d cassandra cqlsh localhost -f /initial_db.sql
</code></pre>

<p><code>initial_db.sql</code> contains the creation of the table:</p>
<pre><code>CREATE KEYSPACE battleapp WITH REPLICATION = { 'class' : 'SimpleStrategy','replication_factor' : 3 };

USE battleapp;

CREATE TABLE EVENTS (
 ID text,
 NAME text,
 VERSION bigint,
 DATE timestamp,
 DATA text,
 PRIMARY KEY(ID, NAME, VERSION)
);
</code></pre>

<h2 id="setup-cassandra-in-the-cluster">Setup Cassandra in the cluster</h2>
<p>To have two separate Cassandra cluster; one for the test environment and one
for the production environment we've to separate the test environment from 
the production environment. That can be achieved with Kubernetes namespaces.
We let our production environment run on the default namespace and the
test environment in a new namespace called <code>test</code>. Therefore we've to create
this new namespace in a file:</p>
<pre><code>apiVersion: v1
kind: Namespace
metadata:
  name: test
</code></pre>

<p>Now we've to tell Kubernetes to create this namespace:</p>
<pre><code>kc create -f namespace.yml
</code></pre>

<p>We can test if the namespace was created with the following command:</p>
<pre><code>kc get namespace | grep test
</code></pre>

<pre><code>test          Active        6h
</code></pre>

<p>For Cassandra we're going to use Kubernetes deamonsets. A deamonset
starts on each node on the cluster a pod that's defined in the
deamonset. We don't want to start Cassandra on every node therefore 
we create more node labels. In this case we set the label <code>group=cassandra</code>
on three nodes:</p>
<pre><code>kc label nodes vmi71989.contabo.host group=cassandra
kc label nodes vmi71992.contabo.host group=cassandra
kc label nodes vmi71992.contabo.host group=cassandra
</code></pre>

<p>We can test this setting with the following command:</p>
<pre><code>kc get no -l group=cassandra
</code></pre>

<pre><code>NAME                    STATUS    AGE
vmi71989.contabo.host   Ready     6d
vmi71992.contabo.host   Ready     10d
vmi74389.contabo.host   Ready     10d
</code></pre>

<p>This is are going to be the nodes for our production Cassandra cluster.
For our test environment we specify just one node with the label
<code>group=cassandra-test</code>.</p>
<pre><code>kc label nodes vmi74388.contabo.host group=cassandra
</code></pre>

<pre><code>kc get no -l group=cassandra-test
</code></pre>

<pre><code>NAME                    STATUS    AGE
vmi74388.contabo.host   Ready     10d
</code></pre>

<p>Now we've to create a service for each environment:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    name: cassandra
  name: cassandra
spec:
  clusterIP: None
  ports:
    - port: 9042
  selector:
    name: cassandra
</code></pre>

<p>And here the service for the test environment:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    name: cassandra
  name: cassandra
  namespace: test
spec:
  clusterIP: None
  ports:
    - port: 9042
  selector:
    name: cassandra
</code></pre>

<p>Then we've to start the services:</p>
<pre><code>kc create -f cassandra.yml
kc create -f cassandra-test.yml
</code></pre>

<p>Now we can create the daemonset for each environment:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  labels:
    name: cassandra
  name: cassandra
spec:
  template:
    metadata:
      labels:
        name: cassandra
    spec:
      # Filter to specific nodes:
      nodeSelector:
        group: cassandra
      containers:
        - command:
            - /run.sh
          env:
            - name: MAX_HEAP_SIZE
              value: 512M
            - name: HEAP_NEWSIZE
              value: 100M
            - name: CASSANDRA_SEED_PROVIDER
              value: &quot;io.k8s.cassandra.KubernetesSeedProvider&quot;
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          image: gcr.io/google-samples/cassandra:v11
          name: cassandra
          ports:
            - containerPort: 7000
              name: intra-node
            - containerPort: 7001
              name: tls-intra-node
            - containerPort: 7199
              name: jmx
            - containerPort: 9042
              name: cql
          volumeMounts:
            - mountPath: /cassandra_data
              name: data
      volumes:
        - name: data
          emptyDir: {}
</code></pre>

<p>And the daemonset for the test environment:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  labels:
    name: cassandra
  name: cassandra
  namespace: test
spec:
  template:
    metadata:
      labels:
        name: cassandra
    spec:
      # Filter to specific nodes:
      nodeSelector:
        group: cassandra-test
      containers:
        - command:
            - /run.sh
          env:
            - name: MAX_HEAP_SIZE
              value: 512M
            - name: HEAP_NEWSIZE
              value: 100M
            - name: CASSANDRA_SEED_PROVIDER
              value: &quot;io.k8s.cassandra.KubernetesSeedProvider&quot;
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          image: gcr.io/google-samples/cassandra:v11
          name: cassandra
          ports:
            - containerPort: 7000
              name: intra-node
            - containerPort: 7001
              name: tls-intra-node
            - containerPort: 7199
              name: jmx
            - containerPort: 9042
              name: cql
          volumeMounts:
            - mountPath: /cassandra_data
              name: data
      volumes:
        - name: data
          emptyDir: {}
</code></pre>

<p>Then we've to start the daemonsets:</p>
<pre><code>kc create -f cassandra.yml
kc create -f cassandra-test.yml
</code></pre>

<p>We can test the setup with the following commands:</p>
<pre><code>kc get po -l name=cassandra
</code></pre>

<pre><code>NAME              READY     STATUS    RESTARTS   AGE
cassandra-19qlh   1/1       Running   0          20h
cassandra-rtgqx   1/1       Running   0          20h
cassandra-tbhz1   1/1       Running   0          20h
</code></pre>

<pre><code>kc exec -it cassandra-19qlh -- nodetool status
</code></pre>

<pre><code>Datacenter: datacenter1
=======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens       Owns (effective)  Host ID                               Rack
UN  10.36.0.3  132.31 KiB  32           71.4%             c6e9ae7e-3806-4e7b-9d7e-f1846e71f33f  rack1
UN  10.42.0.3  132.33 KiB  32           76.2%             3026572a-f232-43fb-a63c-a32b5efb4b32  rack1
UN  10.40.0.5  148.29 KiB  32           67.9%             7f7b469e-8a6b-401d-92de-6a5b363d92e9  rack1
</code></pre>

<p>The same for the test environment:</p>
<pre><code>kc --namespace test get po -l name=cassandra
</code></pre>

<pre><code>NAME              READY     STATUS    RESTARTS   AGE
cassandra-cgj4q   1/1       Running   0          6h
</code></pre>

<pre><code>kc --namespace test exec -it cassandra-cgj4q -- nodetool status
</code></pre>

<pre><code>Datacenter: datacenter1
=======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens       Owns (effective)  Host ID                               Rack
UN  10.44.0.3  124.75 KiB  32           100.0%            5939fe71-23dd-49f5-ae87-4ce174656fb9  rack1
</code></pre>

<p>Finally we've to create the Cassandra namespace and table in both environments
similar to the local setting:</p>
<pre><code>kc exec -it cassandra-19qlh cqlsh cassandra
</code></pre>

<pre><code>Connected to Test Cluster at cassandra:9042.
[cqlsh 5.0.1 | Cassandra 3.9 | CQL spec 3.4.2 | Native protocol v4]
Use HELP for help.
cqlsh&gt;
</code></pre>

<p>And copy and past the content of the <code>initial_db.sql</code>:</p>
<pre><code>CREATE KEYSPACE battleapp WITH REPLICATION = { 'class' : 'SimpleStrategy','replication_factor' : 3 };

USE battleapp;

CREATE TABLE EVENTS (
 ID text,
 NAME text,
 VERSION bigint,
 DATE timestamp,
 DATA text,
 PRIMARY KEY(ID, NAME, VERSION)
);
</code></pre>

<p>The same for the test environment:</p>
<pre><code>kc --namespace test exec -it cassandra-cgj4q cqlsh cassandra
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../02_REST_service_with_event_sourcing/" class="btn btn-neutral float-right" title="02 REST service with event sourcing">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../16_SSO_with_Keycloak/04_Secure_frontend_service/" class="btn btn-neutral" title="Secure the Angular2 frontend service"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/robertBrem/Microservices_with_Kubernetes/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../16_SSO_with_Keycloak/04_Secure_frontend_service/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../02_REST_service_with_event_sourcing/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/require.js"></script>
      <script src="../../search/search.js"></script>

</body>
</html>
